@startuml Prompt Optimization Framework Architecture

!define RECTANGLE_STYLE fill:#E3F2FD,stroke:#1976D2,stroke-width:2px
!define COMPONENT_STYLE fill:#FFF3E0,stroke:#F57C00,stroke-width:2px
!define DATA_STYLE fill:#F1F8E9,stroke:#689F38,stroke-width:2px
!define PROCESS_STYLE fill:#FCE4EC,stroke:#C2185B,stroke-width:2px

title Prompt Optimization Framework - System Architecture

package "Template Layer\n(Phase 1: Quick Wins)" as P1 <<RECTANGLE_STYLE>> {
  [task-execution.yaml\nâ€¢ 12 mandatory sections\nâ€¢ Addresses all patterns] as T1
  [bug-fix.yaml\nâ€¢ Surgical fixes\nâ€¢ Regression prevention] as T2
  [documentation.yaml\nâ€¢ Quality gates\nâ€¢ Structure enforcement] as T3
  [architecture-decision.yaml\nâ€¢ ADR creation\nâ€¢ Option analysis] as T4
  [assessment.yaml\nâ€¢ Evaluation framework\nâ€¢ Metrics capture] as T5
  
  note right of T1
    **Remediation Coverage:**
    âœ“ P1: Success Criteria (â‰¥3 required)
    âœ“ P2: Deliverables with paths
    âœ“ P3: Priority/Sequence section
    âœ“ P4: Constraints (do/don't)
    âœ“ P5: Absolute paths
    âœ“ P7: Handoff section
    âœ“ P8: Checkpoint guidance
    âœ“ P9: Validation in deliverables
    âœ“ P11: Required constraints
    âœ“ P12: Task splitting guidance
  end note
}

package "Validation Layer\n(Phase 2: Enforcement)" as P2 <<RECTANGLE_STYLE>> {
  [prompt-schema.json\nâ€¢ Required sections\nâ€¢ Anti-pattern rules\nâ€¢ Token budgets] as S1
  [prompt-validator.js\nâ€¢ Schema validation\nâ€¢ Quality scoring\nâ€¢ Anti-pattern detection] as V1
  [CI Workflow\nâ€¢ PR validation\nâ€¢ Auto-comments\nâ€¢ Status checks] as CI1
  
  note left of V1
    **Anti-Pattern Detection:**
    â€¢ Vague success criteria (P1)
    â€¢ Scope creep language (P4)
    â€¢ Missing file extensions (P2)
    â€¢ Relative paths (P5)
    â€¢ Redundant reminders (P10)
  end note
}

package "Context Optimization Layer\n(Phase 3: Token Efficiency)" as P3 <<RECTANGLE_STYLE>> {
  [Token Counter\nâ€¢ tiktoken integration\nâ€¢ Accuracy 95%+\nâ€¢ Per-file estimation] as TC1
  [Context Loader\nâ€¢ Progressive loading\nâ€¢ Budget enforcement\nâ€¢ Smart truncation] as CL1
  [Context Budget\nCalculator\nâ€¢ Critical vs Supporting\nâ€¢ Budget allocation\nâ€¢ Skip recommendations] as CB1
  
  note right of CL1
    **Loading Strategy:**
    1. Critical files (must fit)
    2. Supporting files (best effort)
    3. Skip list enforcement
    4. Truncate if necessary
    
    **Addresses Pattern 6:**
    40% input token reduction
    23K-64K â†’ 10K-15K typical
  end note
}

package "Metrics Layer\n(Phase 4: Continuous Improvement)" as P4 <<RECTANGLE_STYLE>> {
  database "Efficiency\nDashboard" as DB1 {
    [Prompt Quality Scores]
    [Token Usage Trends]
    [Clarification Rates]
    [Template Adoption]
  }
  
  [Anomaly Detector\nâ€¢ Quality drops\nâ€¢ Budget violations\nâ€¢ Pattern detection] as AD1
  [Health Score\nTracker\nâ€¢ Framework health\nâ€¢ Monthly reports\nâ€¢ Trend analysis] as HS1
  
  note bottom of DB1
    **Key Metrics:**
    â€¢ Clarification: 30% â†’ <10%
    â€¢ Task duration: 37m â†’ 25m
    â€¢ Token usage: 40K â†’ 28K
    â€¢ Framework health: 92 â†’ 97-98
  end note
}

' --- Integration with Existing Architecture ---

package "Existing Infrastructure" <<DATA_STYLE>> {
  [Export Pipeline\nParser Module\nops/exporters/parser.js] as EP1
  [Validator Module\nops/exporters/validator.js] as EV1
  [Test Infrastructure\n98 passing tests\nJest + CI/CD] as TI1
  [Directive 014\nWork Log Structure] as D14
}

' --- Data Flow ---

T1 -down-> V1 : "Prompt\nYAML"
T2 -down-> V1
T3 -down-> V1
T4 -down-> V1
T5 -down-> V1

S1 -right-> V1 : "Schema\nDefinition"

V1 -down-> CI1 : "Validation\nResults"
V1 -right-> CL1 : "Context\nFile List"

CB1 -down-> CL1 : "Budget\nAllocation"
TC1 -left-> CL1 : "Token\nEstimates"

CI1 -down-> AD1 : "Quality\nScores"
CL1 -down-> DB1 : "Token\nMetrics"
AD1 -right-> HS1 : "Anomalies"

EP1 -up-> V1 : "Reuse YAML\nParsing"
EV1 -up-> V1 : "Extend\nValidation"
TI1 -up-> V1 : "Test\nFramework"
D14 -up-> DB1 : "Work Log\nMetrics"

' --- Pattern Coverage Annotations ---

note as N1
  **12 Pattern Remediation Coverage**
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  P1: Vague criteria â†’ Template + Validator
  P2: Missing deliverables â†’ Template + Schema
  P3: Ambiguous priorities â†’ Template section
  P4: Scope creep â†’ Validator anti-pattern
  P5: Missing paths â†’ Validator + Schema
  P6: Incomplete context â†’ Context Loader
  P7: Implicit handoffs â†’ Template section
  P8: No checkpoints â†’ Template guidance
  P9: Undefined quality â†’ Template validation
  P10: Redundant reminders â†’ Validator
  P11: Missing constraints â†’ Template + Schema
  P12: Overloaded prompts â†’ Validator warning
end note

' --- Impact Metrics ---

note as N2
  **Expected Impact**
  â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  â± Time Saved: 12 min/task (32% faster)
  ğŸ¯ Clarifications: -67% (30% â†’ <10%)
  ğŸª™ Token Efficiency: -30% (40K â†’ 28K)
  â™»ï¸ Rework: -67% (15% â†’ <5%)
  ğŸ“Š Framework Health: +5-6 points (92 â†’ 97-98)
  ğŸ’° Annual ROI: 140-300 hours saved
end note

N1 -[hidden]down- P1
N2 -[hidden]down- P4

' --- Styling ---

skinparam packageStyle rectangle
skinparam component {
  BackgroundColor<<RECTANGLE_STYLE>> #E3F2FD
  BorderColor<<RECTANGLE_STYLE>> #1976D2
  BackgroundColor<<DATA_STYLE>> #F1F8E9
  BorderColor<<DATA_STYLE>> #689F38
}

@enduml

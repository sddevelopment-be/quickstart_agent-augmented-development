# Claude Integration Technical Design

## Document Status

- **Version:** 1.0.0
- **Date:** 2025-01-31
- **Status:** Implemented
- **Related ADRs:** ADR-013 (Zip Distribution)

## Overview

This document describes the technical implementation of the Claude Code integration pipeline, which deploys framework components (skills, agents, prompts) to Claude's directory structure for seamless AI-assisted development.

## Goals

1. **Deployment Automation:** Automated deployment of skills, agents, and prompts to `.claude/` directory
2. **Format Preservation:** Maintain source formats where beneficial for usability
3. **Discoverability:** Provide manifests and documentation for deployed content
4. **Cross-Platform:** Work consistently on Windows, Linux, and macOS
5. **Distribution Ready:** Support inclusion in release packages (ADR-013)

## Architecture

### Component Overview

```
┌─────────────────────────────────────────────────────────────┐
│                     Source Content                           │
├─────────────────────┬────────────────────┬──────────────────┤
│  .github/agents/    │ docs/templates/    │  dist/skills/    │
│  *.agent.md         │ prompts/*.md,yaml  │  claude-code/    │
└──────────┬──────────┴──────────┬─────────┴────────┬─────────┘
           │                     │                   │
           │                     │                   │
    ┌──────▼──────┐      ┌──────▼──────┐    ┌──────▼──────┐
    │  Copy Agent │      │ Copy Prompt │    │ Convert &   │
    │   Files     │      │  Templates  │    │ Deploy Skill│
    └──────┬──────┘      └──────┬──────┘    └──────┬──────┘
           │                     │                   │
           │                     │                   │
    ┌──────▼──────────────────────▼───────────────────▼──────┐
    │              .claude/ Directory Structure                │
    ├──────────────────┬──────────────────┬───────────────────┤
    │  agents/         │  prompts/        │  skills/          │
    │  *.agent.md      │  *.md, *.yaml    │  */SKILL.md       │
    │  manifest.json   │  manifest.json   │                   │
    │  README.md       │  README.md       │                   │
    └──────────────────┴──────────────────┴───────────────────┘
```

### Directory Structure

```
project/
├── .github/
│   └── agents/
│       ├── *.agent.md          # Source agent profiles
│       ├── directives/         # Referenced by agents
│       ├── approaches/         # Referenced by agents
│       └── guidelines/         # Referenced by agents
│
├── docs/
│   └── templates/
│       └── prompts/
│           ├── *.prompt.md     # Markdown templates
│           └── *.yaml          # YAML templates
│
├── dist/                       # Generated by export pipeline
│   ├── skills/
│   │   └── claude-code/
│   │       └── *.skill.json    # Exported skills
│   └── opencode/
│       └── agents/
│
├── .claude/                    # Deployment target
│   ├── skills/                 # Task capabilities
│   │   └── <skill-name>/
│   │       └── SKILL.md
│   ├── agents/                 # Specialist profiles
│   │   ├── *.agent.md
│   │   ├── manifest.json
│   │   └── README.md
│   └── prompts/                # Task templates
│       ├── *.prompt.md
│       ├── *.yaml
│       ├── manifest.json
│       └── README.md
│
└── ops/
    ├── deploy-skills.js        # Main deployment script
    └── __tests__/
        └── deploy-skills.test.js
```

## Implementation Details

### Deployment Script (ops/deploy-skills.js)

#### Command-Line Interface

```bash
node ops/deploy-skills.js [options]

Options:
  --all              Deploy all content types (default)
  --claude           Deploy Claude skills only
  --agents           Deploy Claude agents only
  --prompts          Deploy Claude prompts only
  --copilot          Deploy Copilot instructions
  --opencode         Deploy OpenCode configuration
```

#### npm Scripts

```json
{
  "deploy:claude": "Deploy skills + agents + prompts",
  "deploy:claude:skills": "Deploy skills only",
  "deploy:claude:agents": "Deploy agents only", 
  "deploy:claude:prompts": "Deploy prompts only",
  "deploy:all": "Deploy to all targets (Claude, Copilot, OpenCode)"
}
```

### Agent Deployment

**Function:** `deployClaudeAgents()`

**Process:**
1. Read `.github/agents/*.agent.md` files
2. Parse frontmatter metadata (name, description, tools)
3. Copy files to `.claude/agents/` (preserving format)
4. Generate `manifest.json` with agent inventory
5. Generate `README.md` with usage guide

**Rationale for Copy:**
- Cross-platform compatibility (symlinks unreliable on Windows)
- Stable snapshots for Claude Code
- Clear separation between source and deployment

**Manifest Schema:**
```json
{
  "version": "1.0.0",
  "description": "Claude agent profiles for specialist roles",
  "generated": "2025-01-31T12:00:00.000Z",
  "agents": [
    {
      "id": "backend-dev",
      "name": "backend-benny",
      "description": "Shape resilient service backends...",
      "file": "backend-dev.agent.md"
    }
  ]
}
```

### Prompt Deployment

**Function:** `deployClaudePrompts()`

**Process:**
1. Read `docs/templates/prompts/*.{prompt.md,yaml}` files
2. Parse frontmatter (markdown) or YAML metadata
3. Copy files to `.claude/prompts/` (preserving format)
4. Generate `manifest.json` with prompt inventory
5. Generate `README.md` with format guide

**Format Preservation Rationale:**
- Markdown templates: Human-readable, rich formatting
- YAML templates: Machine-parsable, structured validation
- Both formats serve different use cases

**Manifest Schema:**
```json
{
  "version": "1.0.0",
  "description": "Claude prompt templates for common tasks",
  "generated": "2025-01-31T12:00:00.000Z",
  "prompts": [
    {
      "id": "ARCHITECT_ADR",
      "file": "ARCHITECT_ADR.prompt.md",
      "type": "markdown",
      "description": "Prompt for Architect Alphonso to perform analysis...",
      "agent": "architect-alphonso",
      "category": "architecture"
    }
  ]
}
```

### Skills Deployment (Existing)

**Function:** `deployClaudeSkills()`

**Process:**
1. Read `dist/skills/claude-code/*.json` files (requires export)
2. Convert JSON to SKILL.md format with frontmatter
3. Create directory structure: `.claude/skills/<name>/SKILL.md`

**Note:** Skills deployment unchanged - maintains backward compatibility.

## Data Flow

### Agent Deployment Flow

```
.github/agents/backend-dev.agent.md
  │
  ├─→ Parse frontmatter (name, description, tools)
  │
  ├─→ Copy to .claude/agents/backend-dev.agent.md
  │
  ├─→ Add metadata to manifest.agents[]
  │
  └─→ Include in README.md agent list
```

### Prompt Deployment Flow

```
docs/templates/prompts/ARCHITECT_ADR.prompt.md
  │
  ├─→ Parse frontmatter (description, agent, category)
  │
  ├─→ Copy to .claude/prompts/ARCHITECT_ADR.prompt.md
  │
  ├─→ Add metadata to manifest.prompts[]
  │
  └─→ Include in README.md prompt list
```

## Error Handling

### Deployment Errors

```javascript
const results = { deployed: 0, errors: [] };

try {
  // Deployment logic
  results.deployed++;
} catch (error) {
  console.log(`   ❌ ${file}: ${error.message}`);
  results.errors.push({ file, error: error.message });
}
```

### Missing Sources

- Agents/Prompts: Warn but continue (may not exist in all projects)
- Skills: Warn and suggest running export pipeline
- Directories: Auto-create with `fs.mkdir({ recursive: true })`

### Partial Failures

- Continue processing remaining files
- Report summary with total deployed and error count
- Non-zero exit code only on fatal errors

## Testing Strategy

### Unit Tests (`ops/__tests__/deploy-skills.test.js`)

1. **Agent Deployment:**
   - Creates `.claude/agents/` directory
   - Deploys all `.agent.md` files
   - Generates valid `manifest.json`

2. **Prompt Deployment:**
   - Creates `.claude/prompts/` directory
   - Deploys both `.md` and `.yaml` files
   - Generates valid `manifest.json`

3. **Integration:**
   - `--all` flag deploys all content types
   - Existing skills deployment unaffected

### Manual Testing

```bash
# Clean deployment
rm -rf .claude/agents .claude/prompts
npm run deploy:claude

# Verify files
ls .claude/agents/
ls .claude/prompts/
cat .claude/agents/manifest.json
cat .claude/prompts/manifest.json

# Verify existing skills
ls .claude/skills/
```

## Performance Considerations

### File Operations

- **Copy strategy:** Read → Write (simple, reliable)
- **Parallel operations:** None (sequential for error reporting)
- **Memory usage:** Read entire files (acceptable for text files <100KB)

### Deployment Speed

- **Target:** <5 seconds for full deployment
- **Actual:** ~2 seconds (15 agents + 13 prompts + skills)
- **Bottleneck:** File I/O (negligible for this use case)

## Security Considerations

### File Permissions

- Deployed files inherit directory permissions
- No special permissions required
- `.claude/` directory created with default umask

### Content Validation

- No code execution during deployment
- Markdown/YAML parsed for metadata only (no eval)
- Source files copied verbatim (no transformation vulnerabilities)

## Integration with Distribution Pipeline

### Release Package Structure (ADR-013)

```
quickstart-framework-<version>.zip
├── framework_core/
│   ├── .claude/                    # Pre-deployed content
│   │   ├── agents/
│   │   ├── prompts/
│   │   └── skills/
│   ├── .github/
│   │   └── agents/                 # Agent sources
│   ├── docs/
│   │   └── templates/
│   │       └── prompts/            # Prompt sources
│   └── ops/
│       └── deploy-skills.js        # Deployment script
├── scripts/
│   ├── framework_install.sh
│   └── framework_upgrade.sh
└── META/
    ├── MANIFEST.yml
    └── RELEASE_NOTES.md
```

### Installation Workflow

```bash
# 1. Unzip framework
unzip quickstart-framework-v1.0.0.zip

# 2. Run installation script
cd quickstart-framework-v1.0.0
./scripts/framework_install.sh --target /path/to/project

# 3. Deployment happens automatically
#    - Copies .claude/ directory
#    - Or runs deploy-skills.js if customization needed
```

## Future Enhancements

### Potential Improvements

1. **Symlink Option:** Add `--symlink` flag for development workflow
2. **Watch Mode:** Auto-deploy on source file changes
3. **Validation:** Schema validation for manifests
4. **Templates:** Custom templates for README generation
5. **Filtering:** Deploy subset based on categories/tags
6. **Compression:** Optionally compress deployed artifacts

### Claude Code Integration

If Claude Code adds official support for `.claude/agents/` and `.claude/prompts/`:

1. Update manifest schemas to match official specs
2. Add Claude-specific metadata
3. Implement validation against official schemas
4. Add integration tests with Claude Code CLI (if available)

## Maintenance

### Version Bumps

When framework version changes:
1. Update manifest versions
2. Update README generation timestamps
3. Include version in release notes

### Adding New Content Types

To add new content (e.g., `.claude/workflows/`):

1. Add source directory constant
2. Implement `deployClaude<Type>()` function
3. Add `--<type>` CLI flag
4. Update `main()` function
5. Add npm script
6. Update documentation
7. Add tests

## Related Documents

- [Claude Deployment Guide](../HOW_TO_USE/claude-deployment-guide.md) - User guide
- [ADR-013: Zip Distribution](../architecture/adrs/ADR-013-zip-distribution.md) - Release strategy
- [Distribution Technical Design](./distribution_of_releases_technical_design.md) - Overall pipeline
- [Agent Profiles](.github/agents/README.md) - Agent documentation
- [Prompt Templates](../templates/prompts/README.md) - Prompt documentation

## Revision History

| Version | Date       | Changes                              | Author        |
|---------|------------|--------------------------------------|---------------|
| 1.0.0   | 2025-01-31 | Initial implementation               | Backend Benny |

---

**Implementation:** `ops/deploy-skills.js`  
**Tests:** `ops/__tests__/deploy-skills.test.js`  
**Documentation:** `docs/HOW_TO_USE/claude-deployment-guide.md`

name: Agent Orchestration

on:
  schedule:
    # Run hourly at minute 0
    # Note: Only runs on branches where direct push is allowed (not main)
    - cron: '0 * * * *'
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode (no commits)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  issues: write

concurrency:
  group: orchestration-${{ github.ref }}
  cancel-in-progress: true

jobs:
  orchestrate:
    name: Run Agent Orchestrator
    runs-on: ubuntu-latest
    timeout-minutes: 5
    # Disable on main branch - repository policy disallows direct pushes
    if: github.ref != 'refs/heads/main'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-orchestrator'
      
      - name: Run orchestrator
        id: orchestrate
        run: |
          set -e
          echo "Running agent orchestrator..."
          
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN MODE: Not executing orchestrator"
            echo "orchestrator_ran=false" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          python ops/orchestration/agent_orchestrator.py
          echo "orchestrator_ran=true" >> $GITHUB_OUTPUT
      
      - name: Check for changes
        id: changes
        run: |
          git diff --quiet && echo "has_changes=false" >> $GITHUB_OUTPUT || echo "has_changes=true" >> $GITHUB_OUTPUT
      
      - name: Commit and push changes
        if: steps.changes.outputs.has_changes == 'true' && inputs.dry_run != true
        run: |
          git config --local user.name "Agent Orchestrator"
          git config --local user.email "orchestrator@sddevelopment.be"
          git add work/
          git commit -m "[orchestrator] Auto-assign tasks and update workflow state"
          git push
      
      - name: Update workflow log
        if: always()
        run: |
          timestamp=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          log_file="work/collaboration/WORKFLOW_LOG.md"
          
          if [ "${{ steps.orchestrate.outputs.orchestrator_ran }}" = "true" ]; then
            if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
              echo "" >> "$log_file"
              echo "**${timestamp}** - Orchestrator run completed: Changes committed" >> "$log_file"
            else
              echo "" >> "$log_file"
              echo "**${timestamp}** - Orchestrator run completed: No changes" >> "$log_file"
            fi
          elif [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "" >> "$log_file"
            echo "**${timestamp}** - Orchestrator run: Dry-run mode (skipped)" >> "$log_file"
          else
            echo "" >> "$log_file"
            echo "**${timestamp}** - ❗️ Orchestrator run: Failed or skipped" >> "$log_file"
          fi
          
          # Commit log update if needed
          if git diff --quiet "$log_file"; then
            echo "No log updates to commit"
          else
            git config --local user.name "Agent Orchestrator"
            git config --local user.email "orchestrator@sddevelopment.be"
            git add "$log_file"
            git commit -m "[orchestrator] Update workflow log"
            git push
          fi
      
      - name: Create issue on failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const title = '⚠️ Orchestration workflow failed';
            const body = `The orchestration workflow failed during run ${context.runNumber}.
            
            **Run details:**
            - Workflow: ${context.workflow}
            - Run ID: ${context.runId}
            - Commit: ${context.sha}
            - Triggered by: ${context.eventName}
            
            **Action required:**
            1. Review the [workflow logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
            2. Check work directory state for inconsistencies
            3. Fix any validation errors
            4. Manually trigger a new run if needed
            
            This issue was auto-generated by the orchestration workflow.`;
            
            // Check if similar issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'orchestration,automated'
            });
            
            const existingIssue = issues.data.find(issue => 
              issue.title.includes('Orchestration workflow failed')
            );
            
            if (!existingIssue) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['orchestration', 'automated', 'ci-failure']
              });
            }

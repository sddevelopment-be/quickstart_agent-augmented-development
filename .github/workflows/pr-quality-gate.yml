name: PR Quality Gate

on:
  pull_request:
    branches: [main]
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: pr-quality-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Code Quality Checks
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for better analysis
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-quality'
      
      - name: Install quality tools
        run: |
          python -m pip install --upgrade pip
          pip install black ruff
      
      - name: Check code formatting with Black
        id: black
        run: |
          echo "Checking Python code formatting..."
          if black --check validation/ ops/scripts/ 2>&1 | tee black_output.txt; then
            echo "‚úÖ All Python files are properly formatted"
            echo "black_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Some files need formatting"
            echo "black_passed=false" >> $GITHUB_OUTPUT
            cat black_output.txt
          fi
        continue-on-error: true
      
      - name: Lint with Ruff
        id: ruff
        run: |
          echo "Linting Python code..."
          if ruff check validation/ ops/scripts/ 2>&1 | tee ruff_output.txt; then
            echo "‚úÖ No linting issues found"
            echo "ruff_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Linting issues detected"
            echo "ruff_passed=false" >> $GITHUB_OUTPUT
            cat ruff_output.txt
          fi
        continue-on-error: true
      
      - name: Quality check summary
        if: always()
        run: |
          echo "# Code Quality Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.black.outputs.black_passed }}" = "true" ]; then
            echo "‚úÖ **Black formatting:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Black formatting:** Failed - Run \`black validation/ ops/scripts/\`" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ steps.ruff.outputs.ruff_passed }}" = "true" ]; then
            echo "‚úÖ **Ruff linting:** Passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Ruff linting:** Failed - Run \`ruff check validation/ ops/scripts/ --fix\`" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if quality checks failed
        if: steps.black.outputs.black_passed != 'true' || steps.ruff.outputs.ruff_passed != 'true'
        run: |
          echo "‚ùå Code quality checks failed"
          exit 1

  unit-tests:
    name: Unit Tests with Coverage
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: code-quality
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-coverage'
      
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov PyYAML
      
      - name: Run all unit tests with coverage
        id: unit_tests
        run: |
          echo "Running all unit tests with coverage..."
          python -m pytest validation/test_task_utils.py validation/test_agent_orchestrator.py \
            -v --tb=short \
            --cov=ops/scripts/orchestration \
            --cov-report=term-missing \
            --cov-report=xml \
            --cov-report=html
          echo "‚úÖ Unit tests passed"
          echo "unit_tests_passed=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Upload coverage reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-reports
          path: |
            coverage.xml
            htmlcov/
          retention-days: 30
      
      - name: Generate coverage summary
        if: always()
        run: |
          echo "# Unit Test Coverage Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.unit_tests.outputs.unit_tests_passed }}" = "true" ]; then
            echo "‚úÖ **Unit tests:** Passed (55 tests)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            # Extract coverage percentage if available
            if [ -f "coverage.xml" ]; then
              echo "üìä **Coverage report:** Available in artifacts" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ùå **Unit tests:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if tests failed
        if: steps.unit_tests.outputs.unit_tests_passed != 'true'
        run: |
          echo "‚ùå Unit tests failed"
          exit 1

  e2e-tests:
    name: End-to-End Tests
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: unit-tests
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-e2e'
      
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest PyYAML
      
      - name: Run E2E tests
        id: e2e_tests
        run: |
          echo "Running E2E orchestration tests..."
          python -m pytest validation/test_orchestration_e2e.py -v --tb=short
          echo "‚úÖ E2E tests passed"
          echo "e2e_passed=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Generate E2E summary
        if: always()
        run: |
          echo "# E2E Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.e2e_tests.outputs.e2e_passed }}" = "true" ]; then
            echo "‚úÖ **E2E tests:** Passed (11 tests)" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "**Validated workflows:**" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Simple single-agent task flow" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Sequential workflow (agent handoff)" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Parallel workflow" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Conflict detection" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Timeout detection" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Archive execution" >> $GITHUB_STEP_SUMMARY
            echo "- ‚úÖ Error handling scenarios" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **E2E tests:** Failed" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Fail if E2E tests failed
        if: steps.e2e_tests.outputs.e2e_passed != 'true'
        run: |
          echo "‚ùå E2E tests failed"
          exit 1

  mutation-testing:
    name: Mutation Testing
    runs-on: ubuntu-latest
    timeout-minutes: 30
    needs: [unit-tests, e2e-tests]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-mutation'
      
      - name: Install mutation testing tools
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements-dev.txt
      
      - name: Run mutation tests
        id: mutmut
        run: |
          echo "Running mutation tests on orchestration code..."
          echo "This validates that our tests catch deliberately introduced bugs."
          echo ""
          
          # Run mutmut (may take several minutes)
          if mutmut run --paths-to-mutate=ops/scripts/orchestration/ 2>&1 | tee mutmut_output.txt; then
            echo "mutmut_completed=true" >> $GITHUB_OUTPUT
          else
            echo "mutmut_completed=partial" >> $GITHUB_OUTPUT
          fi
        continue-on-error: true
      
      - name: Generate mutation test results
        if: always()
        run: |
          echo "Generating mutation test summary..."
          
          # Get results
          mutmut results > mutmut_results.txt 2>&1 || true
          mutmut show > mutmut_details.txt 2>&1 || true
          
          echo "# Mutation Testing Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Mutation testing introduces controlled bugs to validate test effectiveness." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f "mutmut_results.txt" ]; then
            echo "## Summary" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat mutmut_results.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è Mutation testing did not complete or produced no results." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üìä **Goal:** 95%+ mutations killed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Legend:**" >> $GITHUB_STEP_SUMMARY
          echo "- üéâ Killed: Test caught the bug (good!)" >> $GITHUB_STEP_SUMMARY
          echo "- üôÅ Survived: Test missed the bug (needs investigation)" >> $GITHUB_STEP_SUMMARY
          echo "- ‚è∞ Timeout: Test took too long" >> $GITHUB_STEP_SUMMARY
      
      - name: Upload mutation test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: mutation-test-results
          path: |
            mutmut_output.txt
            mutmut_results.txt
            mutmut_details.txt
            .mutmut-cache
          retention-days: 30

  sonarcloud:
    name: SonarCloud Analysis
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: [unit-tests, e2e-tests]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for SonarCloud
      
      - name: Setup Python environment
        uses: ./.github/actions/setup-python-env
        with:
          python-version: '3.10'
          cache-key-prefix: 'pip-sonar'
      
      - name: Download coverage reports
        uses: actions/download-artifact@v4
        with:
          name: coverage-reports
      
      - name: SonarCloud placeholder
        run: |
          echo "# SonarCloud Integration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **Not yet integrated. Human assistance required.**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Setup Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To enable SonarCloud analysis:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Sign up at https://sonarcloud.io/" >> $GITHUB_STEP_SUMMARY
          echo "2. Import this repository" >> $GITHUB_STEP_SUMMARY
          echo "3. Add \`SONAR_TOKEN\` secret to GitHub repository" >> $GITHUB_STEP_SUMMARY
          echo "4. Uncomment SonarCloud scan step in this workflow" >> $GITHUB_STEP_SUMMARY
          echo "5. Add \`sonar-project.properties\` configuration file" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Expected Benefits" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- üîç Static code analysis" >> $GITHUB_STEP_SUMMARY
          echo "- üêõ Bug detection" >> $GITHUB_STEP_SUMMARY
          echo "- üîí Security vulnerability scanning" >> $GITHUB_STEP_SUMMARY
          echo "- üìä Code quality metrics" >> $GITHUB_STEP_SUMMARY
          echo "- üìà Technical debt tracking" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Coverage data ready:** \`coverage.xml\` available for SonarCloud" >> $GITHUB_STEP_SUMMARY
      
      # UNCOMMENT AFTER SONARCLOUD SETUP:
      # - name: SonarCloud Scan
      #   uses: SonarSource/sonarcloud-github-action@master
      #   env:
      #     GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      #     SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      #   with:
      #     args: >
      #       -Dsonar.projectKey=sddevelopment-be_quickstart_agent-augmented-development
      #       -Dsonar.organization=sddevelopment-be
      #       -Dsonar.python.coverage.reportPaths=coverage.xml
      #       -Dsonar.sources=ops/scripts/
      #       -Dsonar.tests=validation/

  quality-gate-summary:
    name: Quality Gate Summary
    runs-on: ubuntu-latest
    needs: [code-quality, unit-tests, e2e-tests, mutation-testing, sonarcloud]
    if: always()
    
    steps:
      - name: Generate final summary
        run: |
          echo "# üéØ PR Quality Gate Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check job results
          code_quality="${{ needs.code-quality.result }}"
          unit_tests="${{ needs.unit-tests.result }}"
          e2e_tests="${{ needs.e2e-tests.result }}"
          mutation="${{ needs.mutation-testing.result }}"
          sonar="${{ needs.sonarcloud.result }}"
          
          all_passed=true
          
          echo "| Check | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$code_quality" = "success" ]; then
            echo "| Code Quality | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Code Quality | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            all_passed=false
          fi
          
          if [ "$unit_tests" = "success" ]; then
            echo "| Unit Tests (55 tests) | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Unit Tests (55 tests) | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            all_passed=false
          fi
          
          if [ "$e2e_tests" = "success" ]; then
            echo "| E2E Tests (11 tests) | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| E2E Tests (11 tests) | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
            all_passed=false
          fi
          
          if [ "$mutation" = "success" ]; then
            echo "| Mutation Testing | ‚úÖ Completed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Mutation Testing | ‚ö†Ô∏è Partial/Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$sonar" = "success" ]; then
            echo "| SonarCloud | ‚ö†Ô∏è Not configured |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| SonarCloud | ‚ö†Ô∏è Not configured |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "$all_passed" = true ]; then
            echo "## ‚úÖ All required checks passed!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "This PR is ready for review and merge." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Some checks failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please fix the failing checks before merging." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Quality gate enforced by automated CI/CD pipeline_" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if required checks failed
        if: needs.code-quality.result != 'success' || needs.unit-tests.result != 'success' || needs.e2e-tests.result != 'success'
        run: |
          echo "‚ùå Quality gate failed - required checks did not pass"
          exit 1

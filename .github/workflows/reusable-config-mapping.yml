name: Reusable Config Mapping

on:
  # Trigger on changes to agent files
  push:
    paths:
      - '.github/agents/**'
  
  # Allow manual workflow dispatch
  workflow_dispatch:
    inputs:
      validate_only:
        description: 'Only validate existing config without regenerating'
        required: false
        type: boolean
        default: false

permissions:
  contents: write
  pull-requests: write

jobs:
  convert-and-validate:
    name: Convert Agents to OpenCode
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Check for existing config
        id: check-config
        run: |
          if [ -f "opencode-config.json" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate existing config
        if: steps.check-config.outputs.exists == 'true' && github.event.inputs.validate_only == 'true'
        run: |
          echo "ðŸ” Validating existing configuration..."
          python3 tools/exporters/portability/opencode-spec-validator.py opencode-config.json

      - name: Convert agents to OpenCode format
        if: github.event.inputs.validate_only != 'true'
        run: |
          echo "ðŸ”„ Converting agent configurations..."
          python3 tools/exporters/portability/convert-agents-to-opencode.py \
            --input-dir .github/agents \
            --output opencode-config.json \
            --validate \
            --verbose
      
      - name: Check for changes
        id: check-changes
        if: github.event.inputs.validate_only != 'true'
        run: |
          if git diff --quiet opencode-config.json 2>/dev/null; then
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes to OpenCode configuration"
          else
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "âœ… OpenCode configuration updated"
          fi
      
      - name: Commit changes
        if: steps.check-changes.outputs.changed == 'true' && github.event.inputs.validate_only != 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add opencode-config.json
          git commit -m "chore: update OpenCode configuration from agent changes
          
          Generated by reusable-config-mapping workflow
          Triggered by: ${{ github.event_name }}
          Commit: ${{ github.sha }}"
      
      - name: Push changes
        if: steps.check-changes.outputs.changed == 'true' && github.event.inputs.validate_only != 'true'
        uses: ad-m/github-push-action@v0.8.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.ref }}
      
      - name: Create summary
        if: always()
        run: |
          echo "## OpenCode Configuration Mapping" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.validate_only }}" == "true" ]; then
            echo "**Mode:** Validation only" >> $GITHUB_STEP_SUMMARY
            echo "**Result:** âœ… Configuration is valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Mode:** Convert and validate" >> $GITHUB_STEP_SUMMARY
            
            if [ -f "opencode-config.json" ]; then
              agent_count=$(python3 -c "import json; print(json.load(open('opencode-config.json'))['metadata']['agent_count'])")
              echo "**Agents converted:** $agent_count" >> $GITHUB_STEP_SUMMARY
              
              if [ "${{ steps.check-changes.outputs.changed }}" == "true" ]; then
                echo "**Status:** âœ… Configuration updated and committed" >> $GITHUB_STEP_SUMMARY
              else
                echo "**Status:** â„¹ï¸ No changes detected" >> $GITHUB_STEP_SUMMARY
              fi
            fi
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Files" >> $GITHUB_STEP_SUMMARY
          echo "- Source: \`.github/agents/\`" >> $GITHUB_STEP_SUMMARY
          echo "- Output: \`opencode-config.json\`" >> $GITHUB_STEP_SUMMARY
          echo "- Validator: \`tools/exporters/portability/opencode-spec-validator.py\`" >> $GITHUB_STEP_SUMMARY
          echo "- Converter: \`tools/exporters/portability/convert-agents-to-opencode.py\`" >> $GITHUB_STEP_SUMMARY

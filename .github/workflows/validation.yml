name: Work Directory Validation

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

permissions:
  contents: read
  checks: write
  pull-requests: write

concurrency:
  group: validation-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Work Directory
    runs-on: ubuntu-latest
    timeout-minutes: 2
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Cache Python dependencies
        uses: actions/cache@v3
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-validation-${{ hashFiles('**/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-validation-
            ${{ runner.os }}-pip-
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Validate work directory structure
        id: structure
        run: |
          set -e
          echo "Validating work directory structure..."
          bash validation/validate-work-structure.sh
          echo "‚úÖ Work directory structure is valid"
          echo "structure_valid=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Validate task YAML files
        id: schema
        run: |
          set -e
          echo "Validating task YAML schemas..."
          
          # Find all YAML files in work directory
          task_files=$(find work/ -name "*.yaml" -type f | grep -v ".gitkeep" || true)
          
          if [ -z "$task_files" ]; then
            echo "No task files found to validate"
            echo "schema_valid=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Validate each file
          validation_failed=0
          while IFS= read -r file; do
            echo "Validating: $file"
            if ! python validation/validate-task-schema.py "$file"; then
              validation_failed=1
              echo "‚ùå Failed: $file"
            else
              echo "‚úÖ Valid: $file"
            fi
          done <<< "$task_files"
          
          if [ $validation_failed -eq 1 ]; then
            echo "schema_valid=false" >> $GITHUB_OUTPUT
            exit 1
          fi
          
          echo "‚úÖ All task YAML files are valid"
          echo "schema_valid=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Validate task naming conventions
        id: naming
        run: |
          set -e
          echo "Validating task naming conventions..."
          bash validation/validate-task-naming.sh
          echo "‚úÖ Task naming conventions are valid"
          echo "naming_valid=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Check for E2E tests
        id: check_e2e
        run: |
          if [ -f "validation/test_orchestration_e2e.py" ]; then
            echo "e2e_exists=true" >> $GITHUB_OUTPUT
          else
            echo "e2e_exists=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Run E2E tests
        id: e2e
        if: steps.check_e2e.outputs.e2e_exists == 'true'
        run: |
          set -e
          echo "Running E2E orchestration tests..."
          python -m pytest validation/test_orchestration_e2e.py -v
          echo "‚úÖ E2E tests passed"
          echo "e2e_valid=true" >> $GITHUB_OUTPUT
        continue-on-error: true
      
      - name: Generate validation summary
        id: summary
        if: always()
        run: |
          echo "# Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Structure validation
          if [ "${{ steps.structure.outputs.structure_valid }}" = "true" ]; then
            echo "‚úÖ **Work directory structure:** Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Work directory structure:** Invalid" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Schema validation
          if [ "${{ steps.schema.outputs.schema_valid }}" = "true" ]; then
            echo "‚úÖ **Task YAML schemas:** Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Task YAML schemas:** Invalid" >> $GITHUB_STEP_SUMMARY
          fi
          
          # Naming validation
          if [ "${{ steps.naming.outputs.naming_valid }}" = "true" ]; then
            echo "‚úÖ **Task naming conventions:** Valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Task naming conventions:** Invalid" >> $GITHUB_STEP_SUMMARY
          fi
          
          # E2E tests
          if [ "${{ steps.check_e2e.outputs.e2e_exists }}" = "true" ]; then
            if [ "${{ steps.e2e.outputs.e2e_valid }}" = "true" ]; then
              echo "‚úÖ **E2E tests:** Passed" >> $GITHUB_STEP_SUMMARY
            else
              echo "‚ùå **E2E tests:** Failed" >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "‚ö†Ô∏è **E2E tests:** Not available (skipped)" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          all_valid=true
          [ "${{ steps.structure.outputs.structure_valid }}" != "true" ] && all_valid=false
          [ "${{ steps.schema.outputs.schema_valid }}" != "true" ] && all_valid=false
          [ "${{ steps.naming.outputs.naming_valid }}" != "true" ] && all_valid=false
          [ "${{ steps.check_e2e.outputs.e2e_exists }}" = "true" ] && [ "${{ steps.e2e.outputs.e2e_valid }}" != "true" ] && all_valid=false
          
          if [ "$all_valid" = "true" ]; then
            echo "## ‚úÖ All validations passed" >> $GITHUB_STEP_SUMMARY
            echo "validation_status=success" >> $GITHUB_OUTPUT
          else
            echo "## ‚ùå Some validations failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the errors above and fix the issues." >> $GITHUB_STEP_SUMMARY
            echo "validation_status=failure" >> $GITHUB_OUTPUT
          fi
      
      - name: Comment on PR
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const validationStatus = '${{ steps.summary.outputs.validation_status }}';
            const structureValid = '${{ steps.structure.outputs.structure_valid }}' === 'true';
            const schemaValid = '${{ steps.schema.outputs.schema_valid }}' === 'true';
            const namingValid = '${{ steps.naming.outputs.naming_valid }}' === 'true';
            const e2eExists = '${{ steps.check_e2e.outputs.e2e_exists }}' === 'true';
            const e2eValid = '${{ steps.e2e.outputs.e2e_valid }}' === 'true';
            
            let body = '## üîç Work Directory Validation Results\n\n';
            
            body += '| Check | Status |\n';
            body += '|-------|--------|\n';
            body += `| Work directory structure | ${structureValid ? '‚úÖ Valid' : '‚ùå Invalid'} |\n`;
            body += `| Task YAML schemas | ${schemaValid ? '‚úÖ Valid' : '‚ùå Invalid'} |\n`;
            body += `| Task naming conventions | ${namingValid ? '‚úÖ Valid' : '‚ùå Invalid'} |\n`;
            body += `| E2E tests | ${e2eExists ? (e2eValid ? '‚úÖ Passed' : '‚ùå Failed') : '‚ö†Ô∏è Skipped'} |\n`;
            body += '\n';
            
            if (validationStatus === 'success') {
              body += '### ‚úÖ All validations passed!\n\n';
              body += 'Your work directory changes are valid and ready to merge.';
            } else {
              body += '### ‚ùå Some validations failed\n\n';
              body += 'Please review the [workflow logs](' + context.payload.repository.html_url + '/actions/runs/' + context.runId + ') for details.\n\n';
              body += '**Common fixes:**\n';
              body += '- **Structure issues:** Ensure all required directories exist (inbox, assigned, done, logs, collaboration)\n';
              body += '- **Schema errors:** Check YAML syntax and required fields (id, agent, status, title)\n';
              body += '- **Naming issues:** Follow pattern `YYYY-MM-DDTHHMM-agent-slug.yaml`\n';
              body += '- **E2E failures:** Review test output for specific failures\n\n';
              body += 'Run validation locally:\n';
              body += '```bash\n';
              body += 'bash validation/validate-work-structure.sh\n';
              body += 'python validation/validate-task-schema.py work/path/to/task.yaml\n';
              body += 'bash validation/validate-task-naming.sh\n';
              body += '```';
            }
            
            // Find existing comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            
            const botComment = comments.find(comment => 
              comment.user.type === 'Bot' && 
              comment.body.includes('Work Directory Validation Results')
            );
            
            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body
              });
            }
      
      - name: Fail if validation failed
        if: steps.summary.outputs.validation_status == 'failure'
        run: |
          echo "‚ùå Validation failed - see summary above"
          exit 1

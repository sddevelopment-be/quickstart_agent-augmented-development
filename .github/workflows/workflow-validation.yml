name: Workflow Validation

# Validates all GitHub Actions workflow files for syntax and best practices
# Runs yamllint for YAML syntax and actionlint for GitHub Actions-specific validation

on:
  pull_request:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
      - 'tools/validators/**'
  push:
    branches: [main]
    paths:
      - '.github/workflows/**'
      - '.github/actions/**'
      - 'tools/validators/**'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  yaml-lint:
    name: YAML Syntax Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python for yamllint
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install yamllint
        run: |
          python -m pip install --upgrade pip
          pip install yamllint
      
      - name: Create yamllint config
        run: |
          cat > .yamllint.yml << 'EOF'
          ---
          extends: default
          
          rules:
            line-length:
              max: 120
              level: warning
            indentation:
              spaces: 2
              indent-sequences: true
            comments:
              min-spaces-from-content: 1
            document-start: disable
            truthy:
              allowed-values: ['true', 'false']
          
          ignore: |
            node_modules/
            .git/
            coverage/
            htmlcov/
          EOF
      
      - name: Run yamllint on workflow files
        id: yamllint
        run: |
          echo "üîç Validating YAML syntax in workflow files..."
          echo ""
          
          if yamllint .github/workflows/ .github/actions/ 2>&1 | tee yamllint_output.txt; then
            echo "‚úÖ All YAML files are valid"
            echo "yamllint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå YAML validation failed"
            echo "yamllint_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Generate yamllint summary
        if: always()
        run: |
          echo "# YAML Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.yamllint.outputs.yamllint_passed }}" = "true" ]; then
            echo "‚úÖ **YAML Syntax:** All workflow files are valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **YAML Syntax:** Validation failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Errors Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat yamllint_output.txt >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  action-lint:
    name: GitHub Actions Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: yaml-lint
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Download actionlint
        run: |
          echo "üì• Downloading actionlint..."
          bash <(curl -s https://raw.githubusercontent.com/rhysd/actionlint/main/scripts/download-actionlint.bash)
          echo "$(pwd)" >> $GITHUB_PATH
      
      - name: Run actionlint
        id: actionlint
        run: |
          echo "üîç Validating GitHub Actions workflow files..."
          echo ""
          
          # Run actionlint with shellcheck and pyflakes for embedded scripts
          if ./actionlint -color -verbose 2>&1 | tee actionlint_output.txt; then
            echo "‚úÖ All workflow files pass GitHub Actions validation"
            echo "actionlint_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå GitHub Actions validation failed"
            echo "actionlint_passed=false" >> $GITHUB_OUTPUT
            
            # Don't fail hard - some warnings are acceptable
            # exit 1
          fi
        continue-on-error: true
      
      - name: Generate actionlint summary
        if: always()
        run: |
          echo "# GitHub Actions Validation Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.actionlint.outputs.actionlint_passed }}" = "true" ]; then
            echo "‚úÖ **GitHub Actions:** All workflow files are valid" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ö†Ô∏è **GitHub Actions:** Some warnings detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "## Issues Found" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            cat actionlint_output.txt | head -50 >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          fi

  path-reference-validation:
    name: Path Reference Validation
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: yaml-lint
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
      
      - name: Setup Python for validator
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Install PyYAML
        run: |
          python -m pip install --upgrade pip
          pip install PyYAML
      
      - name: Run path reference validator
        id: path_validator
        run: |
          echo "üîç Validating path references in workflow files..."
          chmod +x tools/validators/validate-path-references.py
          
          if python tools/validators/validate-path-references.py; then
            echo "‚úÖ All path references are valid"
            echo "path_validation_passed=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Invalid path references found"
            echo "path_validation_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Generate path validation summary
        if: always()
        run: |
          echo "# Path Reference Validation" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.path_validator.outputs.path_validation_passed }}" = "true" ]; then
            echo "‚úÖ **Path References:** All paths exist" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚ùå **Path References:** Some paths are missing" >> $GITHUB_STEP_SUMMARY
          fi

  validation-summary:
    name: Validation Summary
    runs-on: ubuntu-latest
    needs: [yaml-lint, action-lint, path-reference-validation]
    if: always()
    
    steps:
      - name: Generate summary
        run: |
          echo "# üéØ Workflow Validation Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          yaml_lint="${{ needs.yaml-lint.result }}"
          action_lint="${{ needs.action-lint.result }}"
          path_validation="${{ needs.path-reference-validation.result }}"
          
          echo "| Validation | Result |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          
          if [ "$yaml_lint" = "success" ]; then
            echo "| YAML Syntax | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| YAML Syntax | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$action_lint" = "success" ]; then
            echo "| GitHub Actions | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| GitHub Actions | ‚ö†Ô∏è Warnings |" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "$path_validation" = "success" ]; then
            echo "| Path References | ‚úÖ Passed |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Path References | ‚ùå Failed |" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "_Workflow validation ensures CI/CD reliability and maintainability_" >> $GITHUB_STEP_SUMMARY
      
      - name: Fail if critical validations failed
        if: needs.yaml-lint.result != 'success' || needs.path-reference-validation.result != 'success'
        run: |
          echo "‚ùå Critical workflow validations failed"
          exit 1

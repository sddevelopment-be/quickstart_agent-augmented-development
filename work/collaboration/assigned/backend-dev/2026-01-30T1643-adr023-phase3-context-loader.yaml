---
status: assigned
agent: backend-dev
priority: high
estimated_duration: 5-6 hours
created_at: 2026-01-30T16:43:00Z
assigned_by: github-copilot
context_files:
  - docs/architecture/adrs/ADR-023-prompt-optimization-framework.md
  - docs/architecture/adrs/ADR-023-implementation-roadmap.md
  - docs/templates/prompts/task-execution.yaml
related_adrs:
  - ADR-023 (Prompt Optimization Framework)
directives:
  - 014 (Work Log Creation)
  - 015 (Store Prompts)
  - 016 (ATDD)
  - 017 (TDD)
depends_on:
  - 2026-01-30T1642-adr023-phase2-prompt-validator.yaml
---

# Task: Implement ADR-023 Phase 3 - Progressive Context Loader with Token Counting

## Objective

Implement the context optimization system for ADR-023 Phase 3, integrating tiktoken for accurate token counting and creating a progressive context loader that intelligently manages file loading within token budgets, achieving 30% token reduction (40.3K → 28K tokens average).

## Context

**Background:**
- Phase 1 created templates with context file organization (Critical/Supporting/Skip)
- Phase 2 added validation and enforcement
- Current state: Heavy context loading (23K-64K tokens) without budget management
- Pattern P6: Incomplete context loading causes token waste

**Current State:**
- Agents load all context files indiscriminately
- No token counting or budget enforcement
- Frequent budget overruns requiring manual intervention
- Average 40,300 tokens per task (15,000 over target)

**Target State:**
- Accurate token counting via tiktoken
- Progressive loading (Critical → Supporting → Skip validation)
- Budget-aware truncation with warnings
- Average 28,000 tokens per task (30% reduction)

## Deliverables

- [ ] File: ops/utils/context-loader.js
      Type: code (Node.js module)
      Validation: Exports ContextLoader class, integrates tiktoken, passes all tests

- [ ] File: validation/agent_exports/context-loader.test.js
      Type: test (Jest)
      Validation: 15+ tests covering budget management, truncation, edge cases, 95%+ coverage

- [ ] File: docs/HOW_TO_USE/context-optimization-guide.md
      Type: documentation
      Validation: Explains token budgets, file categorization, optimization patterns with 5+ examples

- [ ] Update: package.json
      Section: dependencies
      Change: Add "tiktoken": "^1.0.0" or latest stable version

## Success Criteria

- [ ] Token counting accuracy within 5% of actual usage
- [ ] Progressive loader respects budget constraints
- [ ] Graceful handling of budget overflow (truncate or warn)
- [ ] Test suite validates all edge cases
- [ ] Performance: Token estimation <100ms for typical file list
- [ ] Backward compatible with existing prompts (no breaking changes)
- [ ] Documentation includes 5 optimization examples

## Constraints

### Do (Allowed Actions)
- Use tiktoken library for token counting (GPT-4 encoding)
- Implement progressive loading (critical first, then supporting)
- Add budget warnings but allow override if needed
- Follow the code structure from ADR-023 lines 574-670
- Provide both sync and async APIs for flexibility

### Don't (Prohibited Actions)
- Don't break existing prompt execution
- Don't require all prompts to specify budgets (make it optional)
- Don't block execution on budget violations (warn instead)
- Don't modify template files (Phase 1 complete)

### Time Box
300 minutes (5 hours) for implementation + tests + documentation

## Context Files (Load These)

### Critical (Always Load)
1. /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/docs/architecture/adrs/ADR-023-prompt-optimization-framework.md - Lines 571-700 for implementation specs
2. /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/docs/templates/prompts/task-execution.yaml - Template with token budget section

### Supporting (Load If Relevant)
3. /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/docs/architecture/adrs/ADR-023-implementation-roadmap.md - Phase 3 requirements
4. /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/package.json - Check existing dependencies

### Skip (Do Not Load)
- Validator implementation (separate concern)
- CI/CD configuration
- Historical work logs

## Compliance

- Directive 014: /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/.github/agents/directives/014_worklog_creation.md
- Directive 016: /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/.github/agents/directives/016_acceptance_test_driven_development.md
- Directive 017: /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/.github/agents/directives/017_test_driven_development.md
- Directive 023: /home/runner/work/quickstart_agent-augmented-development/quickstart_agent-augmented-development/.github/agents/directives/023_clarification_before_execution.md

**Mode:** /analysis-mode

## Technical Specifications

### Context Loader Class API

From ADR-023 lines 574-670:

```javascript
class ContextLoader {
  constructor(tokenBudget = 20000)
  estimateTokens(text)
  async loadWithBudget(fileList, options = {})
  truncateToFit(content, tokenLimit)
  generateLoadReport()
}
```

### Implementation Requirements

1. **Token Counting Integration**
   ```javascript
   const tiktoken = require('tiktoken');
   const encoding = tiktoken.encoding_for_model('gpt-4');
   
   estimateTokens(text) {
     return encoding.encode(text).length;
   }
   ```

2. **Progressive Loading Strategy**
   - Phase 1: Load all critical files (MUST fit or error)
   - Phase 2: Load supporting files (best effort within budget)
   - Phase 3: Validate skip list (ensure files not loaded)

3. **Budget Management**
   - Default budget: 20,000 tokens (configurable)
   - Hard limit: 150,000 tokens (model maximum)
   - Warning threshold: 80% of budget (16,000 tokens)

4. **Truncation Strategy**
   - If critical file exceeds budget, truncate intelligently:
     - Keep first 30% (context)
     - Keep last 30% (recent changes)
     - Skip middle 40% with marker
   - Preserve code structure (don't break mid-function)

### File List Format

```javascript
{
  critical: [
    { path: '/absolute/path/to/file.js', reason: 'Contains main logic' }
  ],
  supporting: [
    { path: '/absolute/path/to/test.js', reason: 'Test cases for reference' }
  ],
  skip: [
    'historical logs',
    'archived documentation'
  ]
}
```

### Load Report Format

```javascript
{
  files: [
    { 
      path: '/path/to/file', 
      content: '...', 
      tokens: 2500, 
      truncated: false,
      reason: 'Contains interface definitions'
    }
  ],
  totalTokens: 18500,
  budget: 20000,
  utilizationPct: 92.5,
  withinBudget: true,
  warnings: []
}
```

## Test Coverage Requirements

15+ tests covering:
- Token counting accuracy (compare with tiktoken directly)
- Progressive loading (critical → supporting order)
- Budget enforcement (stay within limits)
- Truncation (when files exceed budget)
- Edge cases (empty files, missing files, huge files)
- Performance (estimation <100ms)
- Skip list validation

## Checkpoints

- [ ] Checkpoint 1 (1.5h): Tiktoken integration and token counting working
- [ ] Checkpoint 2 (3h): Progressive loader implementation complete
- [ ] Checkpoint 3 (4h): Test suite complete with edge cases
- [ ] Checkpoint 4 (5h): Documentation complete with optimization examples

## Handoff

After completion, hand off to:

**Next Agent:** build-automation
**Next Task Title:** "Update CI to check token budgets and validate context loading (ADR-023 Phase 3)"
**Context to Carry Forward:**
- Context loader module location and API
- Token budget thresholds and warnings
- Expected usage in prompt templates
- Integration points with existing workflow

## Token Budget

- **Target Input:** 18,000 tokens (ADR + templates + minimal context)
- **Estimated Output:** 1,500-2,500 tokens (code + tests + docs)

## Notes

- Install tiktoken: `npm install tiktoken`
- Use GPT-4 encoding (cl100k_base) for token counting
- Consider making the loader usable both in Node.js and browser contexts
- Provide both promise-based and callback-based APIs for flexibility
- Token counting should cache results for repeated calls on same content
- Document token budget recommendations by task type:
  - Simple tasks: 10K tokens
  - Medium tasks: 20K tokens
  - Complex tasks: 40K tokens
  - Architecture: 60K tokens

---

**Priority:** High  
**Estimated Effort:** 5 hours  
**Assigned To:** Backend Benny  
**Dependencies:** Phase 2 validator completion  
**Due Date:** Phase 3 completion (4 weeks)  
**Status:** Assigned

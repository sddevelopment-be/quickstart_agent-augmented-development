---
id: mfd-task-2.1-opencode-generator
agent: backend-dev
status: new
priority: high
title: 'Task 2.1: Enhance OpenCode Generator (Production-Ready)'
description: "# Task 2.1: Enhance OpenCode Generator (Production-Ready)\n\n## Context\n\
  \n**Project:** Multi-Format Agent Framework Distribution  \n**Dependencies:** Batch\
  \ 1 complete (Parser + IR + Schemas available)\n\nEnhance the prototype OpenCode\
  \ exporter to production quality. OpenCode is the **primary export format** (70/100\
  \ compatibility, cross-platform standard).\n\n## Objective\n\nTransform `tools/opencode-exporter.js`\
  \ prototype into a production-ready generator that uses IR from parser and generates\
  \ compliant OpenCode discovery and definition files with governance extensions.\n\
  \n## Detailed Requirements\n\n### 1. Refactor to Use IR\n\n**Current:** Prototype\
  \ reads markdown directly  \n**Target:** Generator consumes IR from parser\n\n```javascript\n\
  // OLD (prototype)\nconst content = fs.readFileSync(filePath, 'utf8');\nconst frontmatter\
  \ = yaml.load(extractFrontmatter(content));\n\n// NEW (production)\nconst ir = await\
  \ parser.parseAgentFile(filePath);\nconst opencode = generateOpenCodeFromIR(ir);\n\
  ```\n\n### 2. Generate Discovery Files\n\n**File:** `{agent-id}.opencode.json`\n\
  \n```json\n{\n  \"opencode_version\": \"1.0\",\n  \"agent\": {\n    \"id\": \"architect-alphonso\"\
  ,\n    \"name\": \"Architect Alphonso\",\n    \"version\": \"1.0.0\",\n    \"description\"\
  : \"Clarify complex systems with contextual trade-offs\",\n    \"capabilities\"\
  : [\"architecture\", \"design\", \"adr\"],\n    \"category\": \"design\",\n    \"\
  tools\": [\"read\", \"write\", \"plantuml\"],\n    \"profile_url\": \"./ architect.agent.md\"\
  ,\n    \"metadata\": {\n      \"last_updated\": \"2026-01-29\",\n      \"api_version\"\
  : \"1.0.0\",\n      \"directives\": [\"001\", \"006\", \"018\"],\n      \"styleguides\"\
  : [\"version_control_hygiene.md\"]\n    }\n  }\n}\n```\n\n### 3. Generate Definition\
  \ Files\n\n**File:** `{agent-id}.definition.yaml`\n\n```yaml\nopencode_version:\
  \ \"1.0\"\nagent:\n  metadata:\n    id: architect-alphonso\n    version: 1.0.0\n\
  \    category: design\n    tags: [architecture, adr]\n  specification:\n    inputs:\n\
  \      - name: system_context\n        type: string\n        required: true\n  \
  \  outputs:\n      - name: architecture_document\n        type: markdown\n    examples:\n\
  \      - prompt: \"Design microservices\"\n        output: \"ADR document\"\n  governance:\
  \  # CUSTOM EXTENSION\n    directives: [\"001\", \"006\", \"018\"]\n    styleguides:\
  \ [\"version_control_hygiene.md\"]\n    safety_critical: false\n```\n\n### 4. Add\
  \ Governance Extensions\n\n**Required fields in `extensions.saboteurs_governance`:**\n\
  - `directives`: Array of directive codes with required/optional flags\n- `priority_level`:\
  \ high/medium/low (inferred from specialization)\n- `uncertainty_threshold`: From\
  \ collaboration contract (default: 0.3)\n- `escalation_required`: Boolean from narrative\n\
  \n**Required fields in `extensions.multi_agent`:**\n- `orchestration_capable`: true/false\n\
  - `handoff_protocols`: [\"file-based\", \"message-queue\"]\n- `specialization_boundaries`:\
  \ \"explicit\" | \"flexible\"\n\n### 5. Handle Edge Cases\n\n- Missing optional\
  \ frontmatter fields → use defaults\n- Complex tools array → map to OpenCode format\n\
  - Multi-line descriptions → preserve formatting\n- Special characters → proper JSON\
  \ escaping\n- Missing directives → empty array (not null)\n\n### 6. Validation Hooks\n\
  \n- Call validator.validateOpenCodeDiscovery(discoveryFile)\n- Call validator.validateOpenCodeDefinition(definitionFile)\n\
  - Fail generation if validation fails\n- Clear error messages\n\n## Expected Outputs\n\
  \n1. **Generator Module** (`tools/exporters/opencode-generator.js`)\n   ```javascript\n\
  \   /**\n    * Generate OpenCode files from IR\n    * @param {AgentIR} ir - Parsed\
  \ agent IR\n    * @param {string} outputDir - Where to write files\n    * @returns\
  \ {Promise<{discovery: string, definition: string}>} File paths\n    */\n   async\
  \ function generateOpenCode(ir, outputDir) { ... }\n   ```\n\n2. **Unit Tests**\
  \ (`tests/unit/opencode-generator.test.js`)\n   - Test IR → valid discovery file\n\
  \   - Test IR → valid definition file\n   - Test governance extensions present\n\
  \   - Test edge cases (missing fields, special chars)\n   - Test validation integration\n\
  \   - Coverage: >80%\n\n3. **Sample Exports** (`tests/fixtures/opencode/`)\n   -\
  \ `architect-alphonso.opencode.json`\n   - `architect-alphonso.definition.yaml`\n\
  \   - `backend-benny.opencode.json`\n   - `backend-benny.definition.yaml`\n   -\
  \ `reviewer-rachel.opencode.json`\n   - `reviewer-rachel.definition.yaml`\n\n##\
  \ Success Criteria\n\n- ✅ Generates valid OpenCode discovery + definition files\n\
  - ✅ Governance extensions present in all exports\n- ✅ Exports validate against OpenCode\
  \ schema (manual check)\n- ✅ Unit tests pass with >80% coverage\n- ✅ Performance:\
  \ <1 second per agent\n- ✅ All 17 agents export successfully\n\n## Directives to\
  \ Follow\n\n**MUST adhere to:**\n- **Directive 014:** Create work log\n- **Directive\
  \ 016:** ATDD - Write acceptance tests first\n- **Directive 017:** TDD - Red-Green-Refactor\
  \ cycle\n\n## Testing Approach (ATDD/TDD)\n\n### Acceptance Tests (Write First)\n\
  \n```javascript\ndescribe('OpenCode Generator Acceptance', () => {\n  it('generates\
  \ valid discovery file from IR', async () => {\n    const ir = await parser.parseAgentFile('architect.agent.md');\n\
  \    const { discovery } = await generateOpenCode(ir, 'output/');\n    const discoveryData\
  \ = JSON.parse(fs.readFileSync(discovery));\n    \n    expect(discoveryData.opencode_version).toBe('1.0');\n\
  \    expect(discoveryData.agent.id).toBe('architect-alphonso');\n    expect(discoveryData.agent.tools).toContain('plantuml');\n\
  \  });\n  \n  it('includes governance extensions', async () => {\n    const ir =\
  \ await parser.parseAgentFile('architect.agent.md');\n    const { discovery } =\
  \ await generateOpenCode(ir, 'output/');\n    const data = JSON.parse(fs.readFileSync(discovery));\n\
  \    \n    expect(data.agent.metadata.directives).toBeInstanceOf(Array);\n    expect(data.agent.metadata.directives.length).toBeGreaterThan(0);\n\
  \  });\n});\n```\n\n### TDD Cycle\n\n1. **Red:** Test `mapIRToDiscovery(ir)` → fails\
  \ (not implemented)\n2. **Green:** Implement minimal mapping\n3. **Refactor:** Extract\
  \ helper functions\n4. **Repeat** for definition files, governance, validation\n\
  \n## Implementation Steps\n\n1. **Setup** (30 min)\n   - Create test files with\
  \ acceptance tests (failing)\n   - Set up directory structure\n\n2. **Discovery\
  \ Generator** (2 hours, TDD)\n   - Test: Map IR → discovery JSON structure\n   -\
  \ Implement: `mapIRToDiscovery(ir)`\n   - Test: Handle missing fields\n   - Test:\
  \ Format metadata correctly\n   - Refactor\n\n3. **Definition Generator** (2 hours,\
  \ TDD)\n   - Test: Map IR → definition YAML structure\n   - Implement: `mapIRToDefinition(ir)`\n\
  \   - Test: Include schemas (if present in IR)\n   - Test: Format examples\n   -\
  \ Refactor\n\n4. **Governance Extensions** (1 hour)\n   - Test: Extract directives\
  \ from IR\n   - Implement: `extractGovernanceMetadata(ir)`\n   - Test: Inject into\
  \ discovery/definition\n   - Refactor\n\n5. **Integration** (30 min)\n   - Implement:\
  \ `generateOpenCode(ir, outputDir)` (orchestrates above)\n   - Test: Full pipeline\
  \ (IR → files on disk)\n   - Test: All 17 agents\n\n## Timeline\n\n**Start:** After\
  \ Batch 1 complete  \n**Duration:** 6 hours  \n**Deadline:** End of Batch 2, Week\
  \ 2\n\n\n**Task Status:** TODO - Waiting on Batch 1  \n**Blocking Tasks:** Task\
  \ 2.2, 2.3 (other generators)  \n**Critical Path:** Yes\n\n\n*Created by: Project\
  \ Manager*  \n*Date: 2026-01-29*  \n*Priority: HIGH*  \n*Batch: 2 (Export Pipeline\
  \ Core)*\n"
created: '2026-01-29T00:00:00Z'
batch: 'Batch 2: Export Pipeline Core'
milestone: 'Milestone 2: Exporters Functional'
dependencies:
- mfd-task-1.2-implement-parser
- mfd-task-1.4-create-5-schemas
estimated_effort_hours: '6'

---
id: mfd-task-1.2-implement-parser
agent: backend-dev
status: new
priority: critical
title: 'Task 1.2: Implement Markdown Parser'
description: "# Task 1.2: Implement Markdown Parser\n\n## Context\n\n**Project:**\
  \ Multi-Format Agent Framework Distribution  \n**Related ADR:** ADR-013 (Multi-Format\
  \ Distribution Strategy)  \n**Dependencies:** Task 1.1 (IR structure must be defined\
  \ first)\n\nThis task implements the **core data extraction** component of the export\
  \ pipeline. The parser reads `.agent.md` files and produces IR instances that all\
  \ generators consume.\n\n**Why This Matters:**\n- Parser is the single source of\
  \ truth extraction\n- All 3 generators (OpenCode, Copilot, MCP) depend on parser\
  \ output\n- Parse errors propagate to all exports\n- Performance matters (will run\
  \ in CI/CD for every commit)\n\n## Objective\n\nImplement a production-ready Node.js\
  \ parser module that extracts structured data from `.agent.md` files and produces\
  \ Intermediate Representation (IR) instances following the schema defined in Task\
  \ 1.1.\n\n## Detailed Requirements\n\n### Parser Must\n\n1. **Parse YAML Frontmatter**\n\
  \   - Use `js-yaml` library (or equivalent)\n   - Handle multi-line strings, arrays,\
  \ objects\n   - Gracefully handle missing or malformed YAML\n   - Preserve array\
  \ order, object property order\n\n2. **Extract Markdown Sections**\n   - Use regex\
  \ or markdown parser library (e.g., `marked`, `remark`)\n   - Extract sections:\
  \ Purpose, Specialization, Collaboration Contract, Output Artifacts, Mode Defaults\n\
  \   - Handle nested headers (## and ###)\n   - Preserve inline formatting (bold,\
  \ links, code blocks)\n\n3. **Handle Edge Cases**\n   - Missing optional frontmatter\
  \ fields → use defaults\n   - Malformed YAML → fail gracefully with clear error\
  \ message\n   - Multi-line descriptions → preserve line breaks or join intelligently\n\
  \   - Special characters in strings → proper escaping\n   - Empty sections → mark\
  \ as null/undefined\n   - Files without proper structure → validation error\n\n\
  4. **Generate Metadata**\n   - Calculate SHA-256 hash using Node `crypto` module\n\
  \   - Extract last modified timestamp from file system\n   - Get file size in bytes\n\
  \   - Store relative file path\n\n5. **Validate Basic Structure**\n   - Check for\
  \ required fields (name, description, tools at minimum)\n   - Warn on missing recommended\
  \ fields\n   - Error on completely invalid files\n\n### Code Quality Requirements\n\
  \n- **Modular:** Separate concerns (YAML parsing, section extraction, hash generation)\n\
  - **Testable:** Pure functions where possible, dependency injection for file I/O\n\
  - **Error Handling:** Descriptive error messages with file path and line number\
  \ context\n- **Performance:** Process 17 agents in <2 seconds total\n- **Documented:**\
  \ JSDoc comments for all public functions\n\n## Inputs\n\n- **IR Structure:** From\
  \ Task 1.1 (`docs/technical/ir-structure.md`)\n- **Agent Files:** All 16 agent files\
  \ in `.github/agents/*.agent.md`\n- **Prototype Parser:** `tools/opencode-exporter.js`\
  \ (reference implementation)\n\n## Expected Outputs\n\n1. **Parser Module** (`tools/exporters/parser.js`)\n\
  \   ```javascript\n   /**\n    * Parse an agent markdown file into IR\n    * @param\
  \ {string} filePath - Path to .agent.md file\n    * @returns {Promise<AgentIR>}\
  \ Parsed IR object\n    * @throws {ParseError} On invalid file structure\n    */\n\
  \   async function parseAgentFile(filePath) { ... }\n   \n   /**\n    * Parse all\
  \ agent files in a directory\n    * @param {string} dirPath - Directory containing\
  \ .agent.md files\n    * @returns {Promise<AgentIR[]>} Array of IR objects\n   \
  \ */\n   async function parseAgentDirectory(dirPath) { ... }\n   ```\n\n2. **Unit\
  \ Tests** (`tests/unit/parser.test.js`)\n   - Test valid agent file → correct IR\n\
  \   - Test missing optional fields → defaults applied\n   - Test malformed YAML\
  \ → clear error\n   - Test empty sections → null handling\n   - Test hash generation\
  \ → deterministic\n   - Test all 17 agents → no errors\n   - Coverage: >85%\n\n\
  3. **Test Fixtures** (`tests/fixtures/ir/`)\n   - `architect-alphonso.ir.json` (expected\
  \ output for architect agent)\n   - `backend-benny.ir.json` (expected output for\
  \ backend agent)\n   - `reviewer-rachel.ir.json` (expected output for reviewer agent)\n\
  \n## Success Criteria\n\n- ✅ Parser successfully processes all 17 agent files without\
  \ errors\n- ✅ Generated IR validates against IR schema (from Task 1.1)\n- ✅ Unit\
  \ tests pass with >85% code coverage\n- ✅ Error handling produces clear, actionable\
  \ messages\n- ✅ Performance: <2 seconds to parse all 17 agents\n- ✅ Code reviewed\
  \ and approved by Architect Alphonso\n\n## Directives to Follow\n\n**MUST adhere\
  \ to:**\n- **Directive 014:** Create work log documenting implementation decisions\n\
  - **Directive 015:** Store prompt documentation (optional, recommended)\n- **Directive\
  \ 016:** ATDD - Write acceptance tests FIRST\n- **Directive 017:** TDD - Write unit\
  \ tests before implementation (Red-Green-Refactor)\n- **Directive 021:** Locality\
  \ of Change - Focus on parsing, not validation\n\n## Testing Approach (ATDD/TDD)\n\
  \n### Phase 1: Acceptance Tests (Write First)\n\n```javascript\ndescribe('Parser\
  \ Acceptance Tests', () => {\n  it('should parse a complete agent file with all\
  \ fields', async () => {\n    const ir = await parseAgentFile('.github/agents/architect.agent.md');\n\
  \    expect(ir.metadata.name).toBe('architect-alphonso');\n    expect(ir.frontmatter.tools).toContain('plantuml');\n\
  \    expect(ir.source.hash).toMatch(/^[a-f0-9]{64}$/);\n  });\n  \n  it('should\
  \ handle missing optional fields gracefully', async () => {\n    // Create minimal\
  \ valid agent file\n    const ir = await parseAgentFile('tests/fixtures/minimal-agent.md');\n\
  \    expect(ir.frontmatter.version).toBe('1.0.0'); // default\n  });\n  \n  it('should\
  \ fail gracefully on malformed YAML', async () => {\n    await expect(\n      parseAgentFile('tests/fixtures/malformed.md')\n\
  \    ).rejects.toThrow(/Invalid YAML/);\n  });\n});\n```\n\n### Phase 2: Unit Tests\
  \ (TDD Red-Green-Refactor)\n\n1. **Red:** Write failing test for `parseYAMLFrontmatter()`\n\
  2. **Green:** Implement minimal code to pass test\n3. **Refactor:** Improve code\
  \ quality\n4. **Repeat** for each function\n\nExample cycle:\n```javascript\n//\
  \ RED: Test first\ntest('parseYAMLFrontmatter extracts frontmatter', () => {\n \
  \ const content = '---\\nname: test\\n---\\nBody';\n  const result = parseYAMLFrontmatter(content);\n\
  \  expect(result.name).toBe('test');\n});\n\n// GREEN: Minimal implementation\n\
  function parseYAMLFrontmatter(content) {\n  const match = content.match(/^---\\\
  n([\\s\\S]*?)\\n---/);\n  return yaml.load(match[1]);\n}\n\n// REFACTOR: Add error\
  \ handling, edge cases\nfunction parseYAMLFrontmatter(content) {\n  const match\
  \ = content.match(/^---\\n([\\s\\S]*?)\\n---/);\n  if (!match) throw new Error('No\
  \ frontmatter found');\n  try {\n    return yaml.load(match[1]);\n  } catch (e)\
  \ {\n    throw new Error(`Invalid YAML: ${e.message}`);\n  }\n}\n```\n\n## Implementation\
  \ Steps (Recommended)\n\n1. **Setup** (30 min)\n   - Create project structure: `tools/exporters/`,\
  \ `tests/unit/`, `tests/fixtures/`\n   - Install dependencies: `js-yaml`, `jest`\n\
  \   - Write acceptance tests (failing)\n\n2. **YAML Parser** (1 hour, TDD)\n   -\
  \ Test: Extract frontmatter\n   - Implement: `parseYAMLFrontmatter()`\n   - Test:\
  \ Handle missing frontmatter\n   - Implement: Error handling\n   - Test: Multi-line\
  \ values\n   - Refactor: Clean up\n\n3. **Markdown Section Parser** (1.5 hours,\
  \ TDD)\n   - Test: Extract ## Purpose section\n   - Implement: `extractSection(content,\
  \ heading)`\n   - Test: Extract ### Specialization\n   - Test: Handle missing sections\n\
  \   - Refactor: Generic section extractor\n\n4. **Metadata Generator** (1 hour,\
  \ TDD)\n   - Test: SHA-256 hash generation\n   - Implement: `generateFileHash(filePath)`\n\
  \   - Test: Extract file stats (mtime, size)\n   - Implement: `getFileMetadata(filePath)`\n\
  \n5. **IR Assembly** (1.5 hours, TDD)\n   - Test: Combine frontmatter + sections\
  \ + metadata → IR\n   - Implement: `assembleIR(frontmatter, sections, metadata)`\n\
  \   - Test: Apply defaults for missing fields\n   - Test: Validate required fields\
  \ present\n\n6. **Integration** (1 hour)\n   - Implement: `parseAgentFile(filePath)`\
  \ (orchestrates above)\n   - Implement: `parseAgentDirectory(dirPath)` (batch processing)\n\
  \   - Test: Parse all 17 agents\n   - Verify: Performance <2 seconds\n\n## Collaboration\
  \ Notes\n\n**Depends On:**\n- Task 1.1 (IR schema) - MUST be complete before starting\n\
  \n**Handoff To:**\n- Task 1.3 (Schema Conventions) - Parser available for testing\n\
  - Task 2.1 (OpenCode Generator) - Uses parser output\n\n**Review Required From:**\n\
  - Architect Alphonso (IR compliance, design review)\n- Reviewer Rachel (optional\
  \ - test coverage review)\n\n**Commit Frequency:**\n- Commit after each TDD cycle\
  \ (setup, YAML parser, section parser, etc.)\n- Minimum 5 commits (one per implementation\
  \ step)\n- Include test files in each commit\n\n## Additional Context\n\n**Reasoning\
  \ Mode:** `/analysis-mode` (data extraction & transformation)\n\n**Libraries to\
  \ Consider:**\n- `js-yaml` - YAML parsing\n- `gray-matter` - Frontmatter extraction\
  \ (alternative to manual regex)\n- `marked` or `remark` - Markdown parsing (if needed\
  \ for complex section extraction)\n- `crypto` - Built-in Node module for hashing\n\
  \n**Performance Optimization Notes:**\n- Avoid parsing the same file multiple times\n\
  - Cache file reads if called multiple times\n- Use async/await for file I/O\n- Consider\
  \ streaming for very large files (not needed now, but design for it)\n\n**Error\
  \ Message Examples:**\n```\n❌ ParseError: No frontmatter found in .github/agents/architect.agent.md\n\
  \   Expected YAML frontmatter between --- delimiters\n\n❌ ParseError: Invalid YAML\
  \ in .github/agents/backend-dev.agent.md:3\n   → mapping values are not allowed\
  \ here\n\n❌ ValidationError: Missing required field 'name' in .github/agents/test.agent.md\n\
  \   → Add 'name: agent-name' to frontmatter\n```\n\n## Timeline\n\n**Start:** After\
  \ Task 1.1 complete (IR schema defined)  \n**Duration:** 6 hours  \n**Deadline:**\
  \ End of Batch 1, Week 1\n\n\n**Task Status:** TODO - Waiting on Task 1.1  \n**Blocking\
  \ Tasks:** Task 2.1, 2.2, 2.3 (all generators), Task 1.3, 1.4  \n**Critical Path:**\
  \ Yes\n\n\n*Created by: Project Manager*  \n*Date: 2026-01-29*  \n*Priority: CRITICAL*\
  \  \n*Batch: 1 (Foundation & Infrastructure)*\n"
created: '2026-01-29T00:00:00Z'
batch: 'Batch 1: Foundation & Infrastructure'
milestone: 'Milestone 1: Schema Complete'
dependencies:
- mfd-task-1.1-design-ir-structure
estimated_effort_hours: '6'

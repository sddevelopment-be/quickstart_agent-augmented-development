---
id: 2026-02-09T2033-python-pedro-orphan-task-backend
agent: python-pedro
status: new
priority: high
phase: implementation
specification: specifications/initiatives/dashboard-enhancements/orphan-task-assignment.md
feature: "FEAT-DASH-008-03: YAML File Update with Comment Preservation"
title: "Backend: Orphan Task Assignment API Endpoint"
created: 2026-02-09T20:33:00Z
created_by: planning-petra
estimated_hours: 3
artefacts:
  - src/llm_service/dashboard/app.py
  - src/llm_service/dashboard/task_assignment_handler.py
description: |
  # Task: Backend API Endpoint for Orphan Task Assignment
  
  ## Context
  
  **Specification:** SPEC-DASH-008 v1.0.0 (READY_FOR_PLANNING)
  **Architecture Review:** APPROVED (work/reports/architecture/2026-02-09T2028-SPEC-DASH-008-review.md)
  **Phase:** 4-5 (Acceptance Test + Implementation)
  
  **Architectural Decisions:**
  1. Use ruamel.yaml for comment preservation ✅
  2. Implement optimistic locking via file modification time (HTTP 409)
  3. Emit specific `task.assigned` + generic `task.updated` events
  4. Store feature TITLE (human-readable) in YAML
  5. Implement frontmatter caching with file watcher
  
  ## Objective
  
  Create PATCH endpoint `/api/tasks/:task_id/specification` to assign orphan tasks to specifications/features with YAML comment preservation and concurrent edit protection.
  
  ## Acceptance Criteria (ATDD)
  
  **AC1: Assign Orphan Task to Feature**
  ```gherkin
  Given I have an orphan task "Implement rate limiting"
  And I have a specification "specifications/llm-service/api-hardening.md" with feature "Rate Limiting"
  When I send PATCH /api/tasks/:task_id/specification with:
    {
      "specification": "specifications/llm-service/api-hardening.md",
      "feature": "Rate Limiting"
    }
  Then the response status is 200
  And the task YAML file contains:
    specification: specifications/llm-service/api-hardening.md
    feature: "Rate Limiting"
  And the YAML comments are preserved
  And a WebSocket event "task.assigned" is emitted
  ```
  
  **AC2: Prevent Assignment of In-Progress Tasks**
  ```gherkin
  Given I have a task with status: in_progress
  When I send PATCH /api/tasks/:task_id/specification
  Then the response status is 400
  And the error message is "Cannot assign tasks that are currently being worked on"
  ```
  
  **AC3: Handle Concurrent Edit Conflict**
  ```gherkin
  Given I have an orphan task
  And another user modifies the task file
  When I send PATCH /api/tasks/:task_id/specification
  Then the response status is 409
  And the error message is "This task was modified by another user"
  ```
  
  **AC4: Validate Specification Path**
  ```gherkin
  Given I have an orphan task
  When I send PATCH /api/tasks/:task_id/specification with:
    {
      "specification": "../../../etc/passwd"
    }
  Then the response status is 400
  And the error message is "Invalid specification path"
  ```
  
  **AC5: Handle Missing Specification File**
  ```gherkin
  Given I have an orphan task
  And the specification file "specifications/nonexistent.md" does not exist
  When I send PATCH /api/tasks/:task_id/specification with:
    {
      "specification": "specifications/nonexistent.md"
    }
  Then the response status is 400
  And the error message is "Specification file not found"
  ```
  
  ## Implementation Guidance
  
  ### Endpoint Design
  ```python
  @app.route('/api/tasks/<task_id>/specification', methods=['PATCH'])
  def update_task_specification(task_id):
      """
      Assign orphan task to specification/feature.
      
      Request:
          {
              "specification": "specifications/llm-dashboard/orphan-task-assignment.md",
              "feature": "Feature 2: Interactive Selector"  # Optional
          }
      
      Response 200:
          {
              "success": true,
              "task": { ... }
          }
      
      Errors:
          400: Invalid specification path or task not found
          409: Concurrent edit conflict
          500: YAML write failure
      """
      pass
  ```
  
  ### Implementation Steps
  1. Validate specification path (whitelist `specifications/**/*.md`)
  2. Check specification file exists
  3. Load task YAML with ruamel.yaml
  4. Check task status (block if `in_progress`, `done`, `failed`)
  5. Read current file modification time (optimistic lock)
  6. Update `specification:` and `feature:` fields
  7. Write atomically (temp file → rename)
  8. Verify YAML integrity (round-trip test)
  9. Emit WebSocket events: `task.assigned` + `task.updated`
  10. Return success response
  
  ### Reuse Existing Code
  - `src/llm_service/dashboard/task_priority_updater.py` - YAML writing patterns
  - `src/llm_service/dashboard/app.py` - WebSocket emission patterns
  
  ### Testing Strategy
  - **Unit Tests:** Validation, optimistic locking, YAML preservation
  - **Integration Tests:** End-to-end assignment flow, WebSocket emission
  - **Performance:** YAML write operation <300ms (P95)
  
  ## Dependencies
  - None (can start immediately)
  
  ## Handoff
  **Next:** Frontend modal UI task (can run in parallel)
